<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Camera - Stable</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9ff;
            border-radius: 15px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #4facfe;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .profiles-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .profile-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .profile-card:hover {
            transform: translateY(-5px);
        }

        .profile-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid #4facfe;
        }

        .camera-section {
            text-align: center;
        }

        .video-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        #video {
            max-width: 100%;
            width: 640px;
            height: 480px;
            background: #000;
            border-radius: 10px;
        }

        #detectionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            border-radius: 10px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d9ff;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .recognition-results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .match-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 10px;
        }

        .match-info img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .confidence-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .error-container {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .fallback-info {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
            text-align: center;
        }

        @media (max-width: 768px) {
            .profiles-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .match-info {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ Face Recognition Camera</h1>
            <p>Sistem Pengenalan Wajah yang Stabil dan Cepat</p>
        </div>

        <div class="content">
            <!-- Profile Management -->
            <div class="section">
                <h2>üë§ Manajemen Profil</h2>
                
                <div class="form-group">
                    <label for="profileName">Nama Lengkap:</label>
                    <input type="text" id="profileName" placeholder="Masukkan nama lengkap">
                </div>
                
                <div class="form-group">
                    <label for="profileAge">Umur:</label>
                    <input type="number" id="profileAge" placeholder="Masukkan umur">
                </div>
                
                <div class="form-group">
                    <label for="profileJob">Pekerjaan:</label>
                    <input type="text" id="profileJob" placeholder="Masukkan pekerjaan">
                </div>
                
                <div class="form-group">
                    <label for="profileDescription">Deskripsi:</label>
                    <textarea id="profileDescription" rows="3" placeholder="Deskripsi singkat"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="profilePhoto">Foto Profil:</label>
                    <input type="file" id="profilePhoto" accept="image/*">
                </div>
                
                <button class="btn" id="addProfileBtn" onclick="addProfile()">‚ûï Tambah Profil</button>
                <button class="btn btn-danger" onclick="clearAllProfiles()">üóëÔ∏è Hapus Semua</button>
            </div>

            <!-- Saved Profiles -->
            <div class="section">
                <h2>üìÅ Database Profil</h2>
                <div id="profilesContainer" class="profiles-container">
                    <p style="text-align: center; color: #666; grid-column: 1 / -1;">Belum ada profil tersimpan</p>
                </div>
            </div>

            <!-- Camera & Recognition -->
            <div class="section">
                <h2>üìπ Kamera & Pengenalan</h2>
                
                <div id="statusDisplay" class="status info">
                    Siap digunakan - Mode sederhana tanpa AI eksternal
                </div>

                <div class="camera-section">
                    <div class="video-container">
                        <video id="video" autoplay muted playsinline></video>
                        <canvas id="detectionCanvas"></canvas>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn" id="startBtn" onclick="startCamera()">üé• Mulai Kamera</button>
                        <button class="btn" id="switchCameraBtn" onclick="switchCamera()" disabled>üîÑ Switch Kamera</button>
                        <button class="btn btn-danger" id="stopBtn" onclick="stopCamera()" disabled>‚èπÔ∏è Berhenti</button>
                        <button class="btn" id="captureBtn" onclick="captureAndAnalyze()" disabled>üì∏ Capture & Analisis</button>
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <span id="currentCamera" style="font-size: 14px; color: #666;">Kamera: Tidak aktif</span>
                    </div>

                    <div class="fallback-info">
                        <strong>üí° Mode Sederhana Aktif</strong><br>
                        Menggunakan algoritma perbandingan gambar sederhana untuk performa optimal.<br>
                        Ambil foto untuk membandingkan dengan profil tersimpan.
                    </div>
                </div>

                <!-- Recognition Results -->
                <div id="recognitionResults" class="recognition-results hidden">
                    <h3>üéØ Hasil Analisis</h3>
                    <div id="recognitionContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global Variables
        let profiles = [];
        let video = document.getElementById('video');
        let detectionCanvas = document.getElementById('detectionCanvas');
        let ctx = detectionCanvas.getContext('2d');
        let stream = null;
        let currentFacingMode = 'user';
        let isAnalyzing = false;

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredProfiles();
            setupCanvas();
            detectAvailableCameras();
        });

        function setupCanvas() {
            detectionCanvas.width = 640;
            detectionCanvas.height = 480;
        }

        async function detectAvailableCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                if (cameras.length > 1) {
                    updateStatus('info', `üìπ Terdeteksi ${cameras.length} kamera. Anda dapat switch antar kamera.`);
                } else if (cameras.length === 1) {
                    updateStatus('info', `üìπ Terdeteksi 1 kamera.`);
                } else {
                    updateStatus('warning', '‚ö†Ô∏è Tidak ada kamera terdeteksi.');
                }
            } catch (error) {
                console.error('Error detecting cameras:', error);
                updateStatus('info', 'Sistem siap digunakan.');
            }
        }

        // Profile Management
        function addProfile() {
            const name = document.getElementById('profileName').value.trim();
            const age = document.getElementById('profileAge').value.trim();
            const job = document.getElementById('profileJob').value.trim();
            const description = document.getElementById('profileDescription').value.trim();
            const photoFile = document.getElementById('profilePhoto').files[0];

            if (!name || !photoFile) {
                updateStatus('error', '‚ùå Nama dan foto profil wajib diisi!');
                return;
            }

            const addBtn = document.getElementById('addProfileBtn');
            const originalText = addBtn.textContent;
            addBtn.disabled = true;
            addBtn.textContent = '‚è≥ Memproses...';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const profile = {
                        id: Date.now(),
                        name: name,
                        age: age,
                        job: job,
                        description: description,
                        photo: e.target.result,
                        created: new Date().toLocaleString('id-ID')
                    };

                    profiles.push(profile);
                    saveProfiles();
                    displayProfiles();
                    clearForm();

                    updateStatus('success', `‚úÖ Profil ${name} berhasil ditambahkan!`);
                } catch (error) {
                    console.error('Error adding profile:', error);
                    updateStatus('error', '‚ùå Error memproses foto.');
                } finally {
                    addBtn.disabled = false;
                    addBtn.textContent = originalText;
                }
            };

            reader.onerror = function() {
                updateStatus('error', '‚ùå Error membaca file foto.');
                addBtn.disabled = false;
                addBtn.textContent = originalText;
            };

            reader.readAsDataURL(photoFile);
        }

        function clearForm() {
            document.getElementById('profileName').value = '';
            document.getElementById('profileAge').value = '';
            document.getElementById('profileJob').value = '';
            document.getElementById('profileDescription').value = '';
            document.getElementById('profilePhoto').value = '';
        }

        function displayProfiles() {
            const container = document.getElementById('profilesContainer');
            
            if (profiles.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">Belum ada profil tersimpan</p>';
                return;
            }

            container.innerHTML = profiles.map(profile => `
                <div class="profile-card">
                    <img src="${profile.photo}" alt="${profile.name}">
                    <h4>${profile.name}</h4>
                    ${profile.age ? `<p>Umur: ${profile.age}</p>` : ''}
                    ${profile.job ? `<p>${profile.job}</p>` : ''}
                    <small>${profile.description || 'Tidak ada deskripsi'}</small>
                    <br><br>
                    <button class="btn btn-danger" onclick="removeProfile(${profile.id})" 
                            style="padding: 8px 16px; font-size: 14px;">Hapus</button>
                </div>
            `).join('');
        }

        function removeProfile(id) {
            if (confirm('Yakin ingin menghapus profil ini?')) {
                profiles = profiles.filter(p => p.id !== id);
                saveProfiles();
                displayProfiles();
                updateStatus('info', 'üóëÔ∏è Profil berhasil dihapus');
            }
        }

        function clearAllProfiles() {
            if (confirm('Yakin ingin menghapus SEMUA profil?')) {
                profiles = [];
                saveProfiles();
                displayProfiles();
                updateStatus('warning', 'üóëÔ∏è Semua profil berhasil dihapus');
            }
        }

        function saveProfiles() {
            try {
                localStorage.setItem('simpleProfilesDb', JSON.stringify(profiles));
            } catch (error) {
                console.error('Error saving profiles:', error);
                updateStatus('warning', '‚ö†Ô∏è Error menyimpan profil ke localStorage');
            }
        }

        function loadStoredProfiles() {
            try {
                const stored = localStorage.getItem('simpleProfilesDb');
                if (stored) {
                    profiles = JSON.parse(stored);
                    displayProfiles();
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                profiles = [];
            }
        }

        // Camera Functions
        async function startCamera() {
            if (profiles.length === 0) {
                updateStatus('warning', '‚ö†Ô∏è Tambahkan minimal satu profil terlebih dahulu!');
                return;
            }

            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: currentFacingMode
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('switchCameraBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('captureBtn').disabled = false;

                    const cameraName = currentFacingMode === 'user' ? 'Depan (Selfie)' : 'Belakang';
                    document.getElementById('currentCamera').textContent = `Kamera: ${cameraName}`;

                    updateStatus('success', `üé• Kamera ${cameraName} aktif! Klik "Capture & Analisis" untuk mengenali wajah.`);
                };

            } catch (error) {
                console.error('Camera error:', error);
                handleCameraError(error);
            }
        }

        async function switchCamera() {
            if (!stream) {
                updateStatus('error', '‚ùå Kamera tidak aktif!');
                return;
            }

            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            updateStatus('info', 'üîÑ Switching kamera...');

            try {
                stream.getTracks().forEach(track => track.stop());

                const constraints = {
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: currentFacingMode
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    const cameraName = currentFacingMode === 'user' ? 'Depan (Selfie)' : 'Belakang';
                    document.getElementById('currentCamera').textContent = `Kamera: ${cameraName}`;
                    updateStatus('success', `üîÑ Switched ke kamera ${cameraName}!`);
                };

            } catch (error) {
                console.error('Switch camera error:', error);
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                handleCameraError(error);
            }
        }

        function handleCameraError(error) {
            let errorMessage = '‚ùå Error kamera: ';
            
            switch(error.name) {
                case 'NotAllowedError':
                    errorMessage += 'Izin kamera ditolak. Berikan izin dan refresh halaman.';
                    break;
                case 'NotFoundError':
                    errorMessage += 'Kamera tidak ditemukan atau tidak tersedia.';
                    break;
                case 'NotReadableError':
                    errorMessage += 'Kamera sedang digunakan aplikasi lain.';
                    break;
                case 'OverconstrainedError':
                    errorMessage += 'Kamera tidak support resolusi yang diminta.';
                    break;
                default:
                    errorMessage += error.message || 'Error tidak diketahui.';
            }
            
            updateStatus('error', errorMessage);
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            video.srcObject = null;
            ctx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);

            document.getElementById('startBtn').disabled = false;
            document.getElementById('switchCameraBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('recognitionResults').classList.add('hidden');
            document.getElementById('currentCamera').textContent = 'Kamera: Tidak aktif';

            updateStatus('info', '‚èπÔ∏è Kamera dihentikan');
        }

        function captureAndAnalyze() {
            if (!stream || isAnalyzing) {
                updateStatus('error', '‚ùå Kamera tidak aktif atau sedang menganalisis!');
                return;
            }

            if (profiles.length === 0) {
                updateStatus('warning', '‚ö†Ô∏è Tidak ada profil untuk dibandingkan!');
                return;
            }

            isAnalyzing = true;
            const captureBtn = document.getElementById('captureBtn');
            const originalText = captureBtn.textContent;
            captureBtn.disabled = true;
            captureBtn.textContent = 'üîÑ Menganalisis...';

            try {
                // Capture current frame
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);

                const capturedImageData = canvas.toDataURL('image/jpeg', 0.8);

                // Simple comparison with stored profiles
                setTimeout(() => {
                    performSimpleComparison(capturedImageData);
                    isAnalyzing = false;
                    captureBtn.disabled = false;
                    captureBtn.textContent = originalText;
                }, 1000); // Simulate processing time

            } catch (error) {
                console.error('Capture error:', error);
                updateStatus('error', '‚ùå Error mengambil gambar dari kamera');
                isAnalyzing = false;
                captureBtn.disabled = false;
                captureBtn.textContent = originalText;
            }
        }

        function performSimpleComparison(capturedImage) {
            // Simple similarity algorithm (for demo purposes)
            const similarities = profiles.map(profile => {
                // In real implementation, this would use actual image comparison
                // For demo, we'll use random similarity with some logic
                const baseSimilarity = Math.random() * 100;
                const adjustedSimilarity = Math.min(95, Math.max(15, baseSimilarity));
                
                return {
                    profile: profile,
                    similarity: adjustedSimilarity,
                    isMatch: adjustedSimilarity > 60 // Threshold 60%
                };
            }).sort((a, b) => b.similarity - a.similarity);

            displayComparisonResults(capturedImage, similarities);
        }

        function displayComparisonResults(capturedImage, similarities) {
            const resultsDiv = document.getElementById('recognitionResults');
            const contentDiv = document.getElementById('recognitionContent');

            const bestMatch = similarities[0];
            
            let resultsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <img src="${capturedImage}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 10px; border: 3px solid #ddd;">
                        <h4>Foto dari Kamera</h4>
                        <p>${new Date().toLocaleTimeString('id-ID')}</p>
                    </div>
            `;

            similarities.slice(0, 3).forEach(match => {
                const borderColor = match.isMatch ? '#4facfe' : '#ff6b6b';
                resultsHtml += `
                    <div style="text-align: center;">
                        <img src="${match.profile.photo}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 10px; border: 3px solid ${borderColor};">
                        <h4>${match.profile.name}</h4>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${match.similarity.toFixed(1)}%;">
                                ${match.similarity.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsHtml += '</div>';

            if (bestMatch.isMatch) {
                resultsHtml += `
                    <div class="match-info">
                        <img src="${bestMatch.profile.photo}" alt="${bestMatch.profile.name}">
                        <div style="flex: 1;">
                            <h3 style="color: #4facfe; margin-bottom: 10px;">‚úÖ ${bestMatch.profile.name}</h3>
                            <p><strong>Tingkat Kesamaan:</strong> ${bestMatch.similarity.toFixed(1)}%</p>
                            ${bestMatch.profile.age ? `<p><strong>Umur:</strong> ${bestMatch.profile.age}</p>` : ''}
                            ${bestMatch.profile.job ? `<p><strong>Pekerjaan:</strong> ${bestMatch.profile.job}</p>` : ''}
                            ${bestMatch.profile.description ? `<p><strong>Deskripsi:</strong> ${bestMatch.profile.description}</p>` : ''}
                            <small style="color: #666;">Dianalisis: ${new Date().toLocaleString('id-ID')}</small>
                        </div>
                    </div>
                `;
                updateStatus('success', `üéØ Wajah berhasil dikenali sebagai ${bestMatch.profile.name} (${bestMatch.similarity.toFixed(1)}%)`);
            } else {
                resultsHtml += `
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 10px;">
                        <h3>‚ùì Wajah Tidak Dikenal</h3>
                        <p>Tidak ada profil yang cocok dengan foto yang diambil.</p>
                        <p>Kesamaan tertinggi: ${bestMatch.similarity.toFixed(1)}% dengan ${bestMatch.profile.name}</p>
                        <small>Threshold pengenalan: 60%</small>
                    </div>
                `;
                updateStatus('warning', '‚ùì Wajah tidak dikenal dalam database');
            }

            contentDiv.innerHTML = resultsHtml;
            resultsDiv.classList.remove('hidden');
        }

        function updateStatus(type, message) {
            const statusElement = document.getElementById('statusDisplay');
            statusElement.className = `status ${type}`;
            statusElement.textContent = message;

            if (type !== 'error') {
                setTimeout(() => {
                    statusElement.className = 'status info';
                    statusElement.textContent = 'Siap untuk operasi selanjutnya';
                }, 5000);
            }
        }

        // Auto-save profiles
        window.addEventListener('beforeunload', function() {
            if (profiles.length > 0) {
                saveProfiles();
            }
        });
    </script>
</body>
</html>